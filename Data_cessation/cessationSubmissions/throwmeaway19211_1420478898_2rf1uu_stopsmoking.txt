Feeling terrible about myself

I've been dating my girlfriend for a little over 9 months and she thinks I quit at the start of our relationship. I've been smoking on and off since the beginning and I'm starting to feel terrible about it. If I told her I still smoked shed breakup with me and it would break her heart to know I've been lying. I don't want to smoke anymore and I went the past 3 weeks without, until this morning I bought a smoke off a friend and now I regret it so much and I'm feeling so depressed, I can always quit for a few weeks but I can't stop going back. I feel awful because I'm starting all over after all that effort and the lying is killing me.